@using System;
@using System.Linq.Expressions

@inject HttpClient Http

<MudGrid Spacing="2" Justify="Justify.Center">
    @if (_loadState == GridLoadState.Loaded)
    {
        if (_models.Count > 0)
        {
            foreach (var model in _models)
            {
                <MudItem @key=model.Id>
                    <FaceCard Model=model
                              OnRemove=@(async() => await RemoveAsync(model)) />
                </MudItem>
            }
        }
        else
        {
            <MudText Typo=@Typo.body1>No faces saved.</MudText>
        }
    }
    else if (_loadState == GridLoadState.NotLoaded)
    {
        <MudProgressCircular Color=Color.Primary 
                             Size=Size.Large 
                             Indeterminate=true />
    }
    else
    {
        <MudText Typo=@Typo.body1>Failed to load saved faces.</MudText>
    }
</MudGrid>

@code {
    private GridLoadState _loadState;

    private readonly List<FaceCardViewModel> _models = [];

    private readonly HashSet<string> _initialItemValues = new(StringComparer.Ordinal);

    public void AddNew()
    {
        _models.Add(new());
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var req = await Http.GetAsync("Faces");
            req.EnsureSuccessStatusCode();

            var savedFaces = await req.Content.ReadFromJsonAsync<SavedFaceModel[]>() ?? [];

            foreach (var item in savedFaces)
            {
                var viewModel = FaceCardViewModel.FromSaveModel(item);
                _models.Add(viewModel);

                var comparison = viewModel.ToComparisonString();
                _initialItemValues.Add(comparison);
            }

            _loadState = GridLoadState.Loaded;
        }
        catch
        {
            _loadState = GridLoadState.Errored;
        }

        StateHasChanged();
    }

    public async Task<bool> ValidateCardsAsync()
    {
        var valid = true;

        foreach (var item in _models)
        {
            valid &= await item.ValidateAsync();
        }

        return valid;
    }

    public IEnumerable<TrainFaceModel> GetTrainModels()
    {
        foreach (var item in _models)
        {
            if (item.State != CardState.Deleted)
                yield return item.ToTrainModel();
        }
    }

    public bool HasChanges()
    {
        var current = _models.Select(x => x.ToComparisonString()).ToList();

        if (current.Count != _initialItemValues.Count)
            return true;

        if (_initialItemValues.Except(current).Any())
            return true;

        return false;
    }

    private async Task RemoveAsync(FaceCardViewModel model)
    {
        switch (model.State)
        {
            case CardState.Unsaved:
                _models.Remove(model);
                break;
            case CardState.Saved:
                model.State = CardState.Deleted;
                await model.ValidateAsync();
                break;
            case CardState.Deleted:
                model.State = CardState.Saved;
                await model.ValidateAsync();
                break;
        }

        StateHasChanged();
    }
}